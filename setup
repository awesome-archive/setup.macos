#!/bin/sh
# vim: set ft=sh :

set -eu
cd $(dirname $0)

./.setup.xcode.sh
./.setup.brew.sh

echo 'Install from GitHub.'
function git_clone_if_not_exists() {
  DST="${ZDOTDIR:-$HOME}/${2}"
  git -C "${DST}" pull || git clone --recursive "https://github.com/${1}.git" "${DST}"
}
git_clone_if_not_exists sorin-ionescu/prezto .zprezto
git_clone_if_not_exists anyenv/anyenv .anyenv
mkdir -p "${ZDOTDIR:-$HOME}/.anyenv/plugins"
mkdir -p "${ZDOTDIR:-$HOME}/.config/anyenv"
git_clone_if_not_exists znz/anyenv-update .anyenv/plugins/anyenv-update
git_clone_if_not_exists anyenv/anyenv-install .config/anyenv/anyenv-install

echo 'Install the Prezto / zsh.d.'
function force_link() {
  rm -rf "${2}"
  ln -s "${1}" "${2}"
}
for rcfile in $(find "${ZDOTDIR:-$HOME}"/.zprezto/runcoms -type f -name 'z*'); do
  force_link "${rcfile}" "${ZDOTDIR:-$HOME}/.${rcfile##*/}"
done
for rcfile in $(find "$(pwd)" -name '.z*'); do
  force_link "${rcfile}" "${ZDOTDIR:-$HOME}/${rcfile##*/}"
done

echo 'Install the Anyenv & Nodenv.'
source .zsh.d/anyenv
anyenv install nodenv -s
source .zsh.d/anyenv

mkdir -p "${ZDOTDIR:-$HOME}/bin"
force_link "$(pwd)/bin/update" "${ZDOTDIR:-$HOME}/bin/update"
"${ZDOTDIR:-$HOME}/bin/update"
